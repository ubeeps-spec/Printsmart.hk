{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .dashboard-stats {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }
    .stat-card {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        flex: 1;
        min-width: 200px;
        text-align: center;
    }
    .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #333;
        margin: 10px 0;
    }
    .stat-label {
        color: #666;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .dashboard-row {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }
    .dashboard-col {
        flex: 1;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        min-width: 300px;
    }
    h2 { margin-top: 0; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f9f9f9; }
</style>
{% endblock %}

{% block content %}
<div id="content-main">
    <h1>銷售報表 Dashboard</h1>
    
    <div class="dashboard-stats">
        <div class="stat-card">
            <div class="stat-label">總銷售額</div>
            <div class="stat-value">${{ total_sales|floatformat:2|default:"0" }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">訂單總數</div>
            <div class="stat-value">{{ total_orders|default:"0" }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">平均客單價</div>
            <div class="stat-value">${{ avg_order_value|floatformat:2|default:"0" }}</div>
        </div>
    </div>

    <div class="dashboard-row">
        <div class="dashboard-col" style="flex: 2;">
            <h2>銷售趨勢 (近30天)</h2>
            <canvas id="salesChart"></canvas>
        </div>
        <div class="dashboard-col">
            <h2>熱銷商品 TOP 5</h2>
            <table>
                <thead>
                    <tr>
                        <th>商品</th>
                        <th>銷量</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in top_products %}
                    <tr>
                        <td>{{ item.product__name }}</td>
                        <td>{{ item.total_qty }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="2">尚無資料</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('salesChart').getContext('2d');
        const salesData = {
            labels: {{ chart_labels|safe }},
            datasets: [{
                label: '每日銷售額',
                data: {{ chart_data|safe }},
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
                fill: true,
                tension: 0.4
            }]
        };
        
        new Chart(ctx, {
            type: 'line',
            data: salesData,
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value, index, values) {
                                return '$' + value;
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}
